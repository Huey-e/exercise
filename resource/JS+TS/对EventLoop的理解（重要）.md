## å‰è¨€ 

å› ä¸ºæ˜é‡‘æ”¹ç‰ˆä¹‹åå¯¹äºå­—æ•°æœ‰äº†ä¸€å®šçš„é™åˆ¶ï¼ˆäº²æµ‹äº†ä¸‹åœ¨12500å­—å·¦å³ï¼Œæ‰€ä»¥çœ‹åˆ°æ ‡é¢˜è¿˜æœ‰å‡ ä¸‡å­—é•¿æ–‡çš„æ ‡é¢˜ä¸€å®šæ˜¯åœ¨å”¬ä½ çš„ğŸ˜‚ï¼‰æ–‡ç« ç¾åŒ–æ’ç‰ˆä¹‹åå­—æ•°è¶…å‡ºäº†é™åˆ¶æ‰€ä»¥æ‰“ç®—å°†åé¢çš„éƒ¨åˆ†å•ç‹¬æ‹å‡ºæ¥å†™, è¿™æ ·ä¹Ÿæ›´å¥½çš„å†™å‡ºç›¸å¯¹æ¯”è¾ƒæ·±å…¥çš„ä¸€ç‚¹çš„å†…å®¹, å¯¹äº`ã€å‰ç«¯ä½“ç³»ã€‘`è¿™ç±»æ–‡ç« å†…å®¹ä¸€å®šæ˜¯åŒ…æ‹¬ä½†ä¸é™äºæ ‡é¢˜çš„ï¼Œæˆ‘ä¼šå°½å¯èƒ½çš„æ‹“å±•ã€æ·±å…¥ã€ä»¥å†™å‡ºé«˜è´¨é‡çš„å¥½æ–‡ç« ã€‚

> â
> 
> åœ¨çº¿å‘å¾®ï¼Œå¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯æ¬¢è¿å¤§å®¶ç‚¹ä¸ªèµğŸ‘»
> 
> â

## ä»ä¸€é“é¢˜å¼•å‡ºå¯¹Event Loopçš„æ€è€ƒ 

å¯¹äºEvent Loop(äº‹ä»¶è½®è¯¢ï¼‰æ‰€æ¶‰åŠçš„çŸ¥è¯†æ¦‚å¿µå¤ªå¤šäº†ï¼Œå¦‚æœä¸Šæ¥å°±è®²ä¸€å¤§å †æ¦‚å¿µæ€§çš„ä¸œè¥¿å¤ªæ¯ç‡¥ä¸”ä»ä¸€å¼€å§‹å°±æ˜¯æŒ‰ç…§æˆ‘çš„æ€è·¯æ¥èµ°çš„ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—æ¢ä¸€ç§æ–¹å¼æ¥å†™è¿™ç¯‡æ–‡ç« ï¼Œä½ å…ˆæŒ‰ç…§ä½ ä¹‹å‰å¯¹äºEvent Loop(äº‹ä»¶è½®è¯¢)çš„ç†è§£æ¥è§£è¿™é“é¢˜ï¼Œæˆ‘åœ¨åé¢å†™å‡ºæˆ‘ä»Event Loopçš„ç†è§£æ€è€ƒè¿™é¢˜çš„æ–¹å¼ã€‚ä¸¤ç§ä¸åŒçš„ç†è§£ã€æƒ³æ³•ã€äº’ç›¸ç¢°æ’ï¼Œæˆ‘å¯èƒ½æœ‰ç†è§£ä¸å¯¹çš„ï¼Œä½ ä¹Ÿå¯èƒ½æœ‰ä¹‹å‰å¿½ç•¥çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬

![image_f817a190.png](../images//image_f817a190.png)

ä¸å¥½æ„æ€æ”¾é”™äº†ğŸ˜…ï¼Œè¿™å¼ å›¾

![image_2e1f942f.png](../images//image_2e1f942f.png)

### é¢˜ç›® 

```java
console.log('script start');

setTimeout(() => {
  console.log('åŒ—æ­Œ');
}, 1 * 2000);

Promise.resolve()
.then(function() {
  console.log('promise1');
}).then(function() {
  console.log('promise2');
});


async function foo() {
  await bar()
  console.log('async1 end')
}
foo()

async function errorFunc () {
  try {
    await Promise.reject('error!!!')
  } catch(e) {
    console.log(e)
  }
  console.log('async1');
  return Promise.resolve('async1 success')
}
errorFunc().then(res => console.log(res))

function bar() {
  console.log('async2 end') 
}

console.log('script end');
```

å¥½äº†ï¼Œå¯ä»¥æš‚æ—¶ä¸å¾€ä¸‹ç¿»ï¼Œå…ˆæŒ‰ç…§è‡ªå·±çš„ç†è§£æ¥è§£ä¸‹è¿™é“é¢˜ã€‚

\----------------------------------------------- æˆ‘æ˜¯åˆ†å‰²çº¿ --------------------------------------------

ç›¸ä¿¡è¿™é“é¢˜è‚¯å®šéš¾ä¸å€’å¤§å®¶ï¼Œä½†æ˜¯å¤§å®¶æ˜¯æŒ‰ç…§ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥è§£å‡ºè¿™é“é¢˜çš„å‘¢ï¼Ÿå…¶å®è¿™é“é¢˜è€ƒå¯Ÿä½ äº†å¾ˆå¤šçŸ¥è¯†ç‚¹ï¼Œä¸‹é¢æˆ‘å°†ç”¨æˆ‘çš„ç†è§£æ¥è¯´è¯´å¯¹è¿™é“é¢˜çš„æ€è€ƒã€‚æ°´å¹³æœ‰é™ã€æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿è¯„è®ºåŒºæŒ‡å‡ºã€‚

## JSçš„è¿è¡Œæœºåˆ¶ 

![image_432c22f7.png](../images//image_432c22f7.png)

å…ˆæ¥è§£é‡Šä¸Šå›¾ä¸­å‡ºç°çš„å‡ ä¸ªå•è¯æ‰€è¦è¡¨è¾¾çš„å«ä¹‰ã€‚

Heap(å †)ã€Stack(æ ˆ)ã€Queue(é˜Ÿåˆ—)ã€Event Loop(äº‹ä»¶è½®è¯¢)

### ç¨‹åºä¸­çš„å †æ ˆé˜Ÿåˆ— 

Heap(å †)

å †ï¼Œ æ˜¯ä¸€ç§åŠ¨æ€å­˜å‚¨ç»“æ„ï¼Œæ˜¯åˆ©ç”¨å®Œå…¨äºŒå‰æ ‘ç»´æŠ¤çš„ä¸€ç»„æ•°æ®ï¼Œå †åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§ä¸ºæœ€å¤§å †ï¼Œä¸€ç§ä¸ºæœ€å°å †ï¼Œå°†æ ¹èŠ‚ç‚¹æœ€å¤§çš„å †å«åšæœ€å¤§å †æˆ–å¤§æ ¹å †ï¼Œæ ¹èŠ‚ç‚¹æœ€å°çš„å †å«åšæœ€å°å †æˆ–å°æ ¹å †ã€‚ å †æ˜¯çº¿æ€§æ•°æ®ç»“æ„ï¼Œç›¸å½“äºä¸€ç»´æ•°ç»„ï¼Œæœ‰å”¯ä¸€åç»§ã€‚

å¦‚æœ€å¤§å †

![image_edcc379d.png](../images//image_edcc379d.png)

æ ˆï¼ˆStackï¼‰

æ ˆåœ¨ç¨‹åºä¸­çš„è®¾å®šæ˜¯é™å®šä»…åœ¨è¡¨å°¾è¿›è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œçš„çº¿æ€§è¡¨ã€‚ æ ˆæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒæŒ‰ç…§åè¿›å…ˆå‡º(`LIFO: last-in-first-out`)çš„åŸåˆ™å­˜å‚¨æ•°æ®ï¼Œå…ˆè¿›å…¥çš„æ•°æ®è¢«å‹å…¥æ ˆåº•ï¼Œæœ€åçš„æ•°æ®åœ¨æ ˆé¡¶ï¼Œéœ€è¦è¯»æ•°æ®çš„æ—¶å€™ä»æ ˆé¡¶å¼€å§‹å¼¹å‡ºæ•°æ®ã€‚ æ ˆæ˜¯åªèƒ½åœ¨æŸä¸€ç«¯æ’å…¥å’Œåˆ é™¤çš„ç‰¹æ®Šçº¿æ€§è¡¨ã€‚ ![image_2579bc78.png](../images//image_2579bc78.png)

é˜Ÿåˆ—ï¼ˆQueueï¼‰

é˜Ÿåˆ—ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒåªå…è®¸åœ¨è¡¨çš„å‰ç«¯ï¼ˆ`front`ï¼‰è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè€Œåœ¨è¡¨çš„åç«¯ï¼ˆ`rear`ï¼‰è¿›è¡Œæ’å…¥æ“ä½œï¼Œå’Œæ ˆä¸€æ ·ï¼Œé˜Ÿåˆ—æ˜¯ä¸€ç§æ“ä½œå—é™åˆ¶çš„çº¿æ€§è¡¨ã€‚ è¿›è¡Œæ’å…¥æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå°¾ï¼Œè¿›è¡Œåˆ é™¤æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå¤´ã€‚ é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ æ—¶ï¼Œç§°ä¸ºç©ºé˜Ÿåˆ—ã€‚

é˜Ÿåˆ—çš„æ•°æ®å…ƒç´ åˆç§°ä¸ºé˜Ÿåˆ—å…ƒç´ ã€‚åœ¨é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ç§°ä¸ºå…¥é˜Ÿï¼Œä»é˜Ÿåˆ—ä¸­åˆ é™¤ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ç§°ä¸ºå‡ºé˜Ÿã€‚å› ä¸ºé˜Ÿåˆ—åªå…è®¸åœ¨ä¸€ç«¯æ’å…¥ï¼Œåœ¨å¦ä¸€ç«¯åˆ é™¤ï¼Œæ‰€ä»¥åªæœ‰æœ€æ—©è¿›å…¥é˜Ÿåˆ—çš„å…ƒç´ æ‰èƒ½æœ€å…ˆä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œæ•…é˜Ÿåˆ—åˆç§°ä¸ºå…ˆè¿›å…ˆå‡ºï¼ˆ`FIFO: first-in-first-out`ï¼‰ ![image_e6f11d45.png](../images//image_e6f11d45.png)

### jsä¸­çš„å †æ ˆé˜Ÿåˆ— 

ä¸‹é¢æˆ‘è§£é‡Šä¸‹JavaScriptè¯­è¨€ä¸­çš„å †ã€æ ˆã€é˜Ÿåˆ—ã€‚

å †

å †ï¼Œ åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå¤§å°ä¸å®šä¹Ÿä¸ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå­˜æ”¾å¼•ç”¨ç±»å‹ï¼ŒæŒ‡é‚£äº›å¯èƒ½ç”±å¤šä¸ªå€¼æ„æˆçš„å¯¹è±¡ï¼Œä¿å­˜åœ¨å †å†…å­˜ä¸­ï¼ŒåŒ…å«å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œå®é™…ä¸Šä¿å­˜çš„ä¸æ˜¯å˜é‡æœ¬èº«ï¼Œè€Œæ˜¯æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºå­˜å‚¨ä»£ç å—ã€‚

å †çš„ä½œç”¨ï¼šå­˜å‚¨å¼•ç”¨ç±»å‹å€¼çš„æ•°æ®

```java
let obj = {
    name: 'åŒ—æ­Œ'ï¼Œ
    puslic: 'å‰ç«¯è‡ªå­¦é©¿ç«™'
}

let func = () => {
    console.log('hello world')
}
```

![image_0cc6cebf.png](../images//image_0cc6cebf.png)

æ ˆ

jsä¸­çš„æ ˆå‡†ç¡®æ¥å°†åº”è¯¥å«è°ƒç”¨æ ˆ(EC Stack)ï¼Œä¼šè‡ªåŠ¨åˆ†é…å†…å­˜ç©ºé—´ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå­˜æ”¾åŸºæœ¬ç±»å‹ï¼Œç®€å•çš„æ•°æ®æ®µï¼Œå æ®å›ºå®šå¤§å°çš„ç©ºé—´ã€‚

æ ˆçš„ä½œç”¨ï¼šå­˜å‚¨åŸºæœ¬ç±»å‹å€¼ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆè¦çš„ä½œç”¨ã€‚æä¾›ä»£ç æ‰§è¡Œçš„ç¯å¢ƒ

é˜Ÿåˆ—

jsä¸­çš„é˜Ÿåˆ—å¯ä»¥å«åšä»»åŠ¡é˜Ÿåˆ—æˆ–å¼‚æ­¥é˜Ÿåˆ—ï¼Œä»»åŠ¡é˜Ÿåˆ—é‡Œå­˜æ”¾å„ç§å¼‚æ­¥æ“ä½œæ‰€æ³¨å†Œçš„å›è°ƒï¼Œé‡Œé¢åˆ†ä¸ºä¸¤ç§ä»»åŠ¡ç±»å‹ï¼Œå®ä»»åŠ¡(`macroTask`)å’Œå¾®ä»»åŠ¡(`microTask`)ã€‚

å¥½ï¼Œä¸‹é¢å¯ä»¥å›åˆ°æ­£é¢˜ä¸Šæ¥äº†ã€‚

### ä¸ºä»€ä¹ˆä¼šå‡ºç°Event Loop 

æ€»æ‰€å‘¨çŸ¥JSæ˜¯ä¸€é—¨å•çº¿ç¨‹çš„éé˜»å¡è„šæœ¬è¯­è¨€ï¼ŒEvent Loopå°±æ˜¯ä¸ºäº†è§£å†³JSå¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

![image_7f2d89ee.png](../images//image_7f2d89ee.png)

### JSä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œé‚£å®ƒæ˜¯æ€ä¹ˆå®ç°å¼‚æ­¥ç¼–ç¨‹(éé˜»å¡)è¿è¡Œçš„ 

ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š JavaScriptçš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†å¤„ç†æµè§ˆå™¨ç½‘é¡µçš„äº¤äº’ï¼ˆDOMæ“ä½œçš„å¤„ç†ã€UIåŠ¨ç”»ç­‰), è®¾è®¡æˆå•çº¿ç¨‹çš„åŸå› å°±æ˜¯ä¸æƒ³è®©æµè§ˆå™¨å˜å¾—å¤ªå¤æ‚ï¼Œå› ä¸ºå¤šçº¿ç¨‹éœ€è¦å…±äº«èµ„æºã€ä¸”æœ‰å¯èƒ½ä¿®æ”¹å½¼æ­¤çš„è¿è¡Œç»“æœï¼ˆä¸¤ä¸ªçº¿ç¨‹ä¿®æ”¹äº†åŒä¸€ä¸ªDOMèŠ‚ç‚¹å°±ä¼šäº§ç”Ÿä¸å¿…è¦çš„éº»çƒ¦ï¼‰ï¼Œè¿™å¯¹äºä¸€ç§ç½‘é¡µè„šæœ¬è¯­è¨€æ¥è¯´è¿™å°±å¤ªå¤æ‚äº†ã€‚

ç¬¬äºŒä¸ªé—®é¢˜ï¼š JavaScriptæ˜¯å•çº¿ç¨‹çš„ä½†å®ƒæ‰€è¿è¡Œçš„å®¿ä¸»ç¯å¢ƒâ€”æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹ï¼Œæµè§ˆå™¨æä¾›äº†å„ç§çº¿ç¨‹ä¾›Event Loopè°ƒåº¦æ¥åè°ƒJSå•çº¿ç¨‹è¿è¡Œæ—¶ä¸ä¼šé˜»å¡ã€‚

### å°ç»“ 

å…ˆæ€»ç»“ä¸€æ³¢ä¸ªäººå¯¹äºJSè¿è¡Œæœºåˆ¶çš„ç†è§£ï¼š

> ä»£ç æ‰§è¡Œå¼€å¯ä¸€ä¸ªå…¨å±€è°ƒç”¨æ ˆ(ä¸»æ ˆ)æä¾›ä»£ç è¿è¡Œçš„ç¯å¢ƒï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»»åŠ¡çš„ä»£ç ç«‹å³æ‰§è¡Œï¼Œé‡åˆ°å¼‚æ­¥ä»»åŠ¡å°†å¼‚æ­¥çš„å›è°ƒæ³¨å†Œåˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•æŸ¥çœ‹å¼‚æ­¥æ˜¯å¦å®Œæˆï¼Œå¦‚æœå®Œæˆå°†å½“å‰å¼‚æ­¥ä»»åŠ¡çš„å›è°ƒæ‹¿åˆ°ä¸»æ ˆä¸­æ‰§è¡Œ

## è¿›ç¨‹å’Œçº¿ç¨‹ 

è¿›ç¨‹ï¼šè¿›ç¨‹æ˜¯ CPU èµ„æºåˆ†é…çš„æœ€å°å•ä½(æ˜¯èƒ½æ‹¥æœ‰èµ„æºå’Œç‹¬ç«‹è¿è¡Œçš„æœ€å°å•ä½)

çº¿ç¨‹ï¼šçº¿ç¨‹æ˜¯ CPU è°ƒåº¦çš„æœ€å°å•ä½(çº¿ç¨‹æ˜¯å»ºç«‹åœ¨è¿›ç¨‹çš„åŸºç¡€ä¸Šçš„ä¸€æ¬¡ç¨‹åºè¿è¡Œå•ä½)

å¯¹äºè¿›ç¨‹å’Œçº¿ç¨‹å¹¶æ²¡æœ‰ç¡®åˆ‡ç»Ÿä¸€çš„æè¿°ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ï¼š

> æ¯”å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åº: å¦‚QQã€æµè§ˆå™¨å¯åŠ¨æ—¶ä¼šå¼€å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œè¯¥è¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹æ¥è¿›è¡Œèµ„æºè°ƒåº¦å’Œåˆ†é…ï¼Œè¾¾åˆ°è¿è¡Œç¨‹åºçš„ä½œç”¨ã€‚
> 
> æ›´é€šä¿—çš„è¯è®²ï¼šæ‰“å¼€QQåº”ç”¨ç¨‹åºå¼€å¯äº†è¿›ç¨‹æ¥è¿è¡Œç¨‹åº(QQ), æœ‰å¤šä¸ªçº¿ç¨‹æ¥è¿›è¡Œèµ„æºè°ƒåº¦å’Œåˆ†é…(å¤šä¸ªçº¿ç¨‹æ¥åˆ†é…æ‰“å¼€QQæ‰€å ç”¨çš„è¿å­˜)ï¼Œè¾¾åˆ°è¿è¡Œç¨‹åº(QQ)çš„ä½œç”¨.

ç”¨æ“ä½œç³»ç»Ÿæ¥ä½œä¸ªä¾‹å­ï¼š

![image_ee7e554f.png](../images//image_ee7e554f.png)

> çº¿ç¨‹ä¾èµ–è¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹åªèƒ½æ˜¯å±äºä¸€ä¸ªè¿›ç¨‹ã€‚

### JSçš„å•çº¿ç¨‹ 

jsçš„å•çº¿ç¨‹æŒ‡çš„æ˜¯javaScriptå¼•æ“åªæœ‰ä¸€ä¸ªçº¿ç¨‹

å•çº¿ç¨‹å°±æ„å‘³ç€ï¼Œæ‰€æœ‰ä»»åŠ¡éœ€è¦æ’é˜Ÿï¼Œå‰ä¸€ä¸ªä»»åŠ¡ç»“æŸï¼Œæ‰ä¼šæ‰§è¡Œåä¸€ä¸ªä»»åŠ¡ã€‚å¦‚æœå‰ä¸€ä¸ªä»»åŠ¡è€—æ—¶å¾ˆé•¿ï¼Œåä¸€ä¸ªä»»åŠ¡å°±ä¸å¾—ä¸ä¸€ç›´ç­‰ç€ã€‚ js å¼•æ“æ‰§è¡Œå¼‚æ­¥ä»£ç è€Œä¸ç”¨ç­‰å¾…ï¼Œæ˜¯å› æœ‰ä¸ºæœ‰ä»»åŠ¡é˜Ÿåˆ—å’Œäº‹ä»¶è½®è¯¢ã€‚

 *  ä»»åŠ¡é˜Ÿåˆ—ï¼šä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œå®ƒé‡Œé¢å­˜æ”¾ç€å„ç§ä»»åŠ¡å›è°ƒã€‚
 *  äº‹ä»¶è½®è¯¢ï¼šäº‹ä»¶è½®è¯¢æ˜¯æŒ‡ä¸»çº¿ç¨‹é‡å¤ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ã€‚

### æµè§ˆå™¨çš„å¤šçº¿ç¨‹ 

1.  GUI æ¸²æŸ“çº¿ç¨‹
    
     *  ç»˜åˆ¶é¡µé¢ï¼Œè§£æ HTMLã€CSSï¼Œæ„å»º DOM æ ‘ï¼Œå¸ƒå±€å’Œç»˜åˆ¶ç­‰
     *  é¡µé¢é‡ç»˜å’Œå›æµ
     *  ä¸ JS å¼•æ“çº¿ç¨‹äº’æ–¥ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ JS æ‰§è¡Œé˜»å¡é¡µé¢æ›´æ–°
2.  JS å¼•æ“çº¿ç¨‹
    
     *  è´Ÿè´£ JS è„šæœ¬ä»£ç çš„æ‰§è¡Œ
     *  è´Ÿè´£å‡†æ‰§è¡Œå‡†å¤‡å¥½å¾…æ‰§è¡Œçš„äº‹ä»¶ï¼Œå³å®šæ—¶å™¨è®¡æ•°ç»“æŸï¼Œæˆ–å¼‚æ­¥è¯·æ±‚æˆåŠŸå¹¶æ­£ç¡®è¿”å›çš„äº‹ä»¶
     *  ä¸ GUI æ¸²æŸ“çº¿ç¨‹äº’æ–¥ï¼Œæ‰§è¡Œæ—¶é—´è¿‡é•¿å°†é˜»å¡é¡µé¢çš„æ¸²æŸ“
3.  äº‹ä»¶è§¦å‘çº¿ç¨‹
    
     *  è´Ÿè´£å°†å‡†å¤‡å¥½çš„äº‹ä»¶äº¤ç»™ JS å¼•æ“çº¿ç¨‹æ‰§è¡Œ
     *  å¤šä¸ªäº‹ä»¶åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—çš„æ—¶å€™éœ€è¦æ’é˜Ÿç­‰å¾…(JS çš„å•çº¿ç¨‹)
4.  å®šæ—¶å™¨è§¦å‘çº¿ç¨‹
    
     *  è´Ÿè´£æ‰§è¡Œå¼‚æ­¥çš„å®šæ—¶å™¨ç±»çš„äº‹ä»¶ï¼Œå¦‚ setTimeoutã€setInterval
     *  å®šæ—¶å™¨åˆ°æ—¶é—´ä¹‹åæŠŠæ³¨å†Œçš„å›è°ƒåŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾
5.  HTTP è¯·æ±‚çº¿ç¨‹
    
     *  è´Ÿè´£æ‰§è¡Œå¼‚æ­¥è¯·æ±‚
     *  ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç é‡åˆ°å¼‚æ­¥è¯·æ±‚çš„æ—¶å€™ä¼šæŠŠå‡½æ•°äº¤ç»™è¯¥çº¿ç¨‹å¤„ç†ï¼Œå½“ç›‘å¬åˆ°çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œå¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œè¯¥çº¿ç¨‹ä¼šæŠŠå›è°ƒå‡½æ•°åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ç­‰å¾…æ‰§è¡Œ

## Event Loop 

å‘¼ï¼Œç»ˆäºå›åˆ°æ­£é¢˜äº†ï¼

å¯¹äºäº‹ä»¶è½®è¯¢ä¸Šé¢å…¶å®å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼š

> äº‹ä»¶è½®è¯¢å°±æ˜¯è§£å†³javaScriptå•çº¿ç¨‹å¯¹äºå¼‚æ­¥æ“ä½œçš„ä¸€äº›ç¼ºé™·ï¼Œè®© javaScriptåšåˆ°æ—¢æ˜¯å•çº¿ç¨‹ï¼Œåˆç»å¯¹ä¸ä¼šé˜»å¡çš„æ ¸å¿ƒæœºåˆ¶ï¼Œæ˜¯ç”¨æ¥åè°ƒå„ç§äº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬æ‰§è¡Œã€UI æ¸²æŸ“ã€ç½‘ç»œè¯·æ±‚ç­‰çš„ä¸€ç§æœºåˆ¶ã€‚

### æµè§ˆå™¨ä¸­çš„Eveent Loopæ‰§è¡Œé¡ºåº 

[Processing model][]è§„èŒƒå®šä¹‰äº†`Eveent Loop`çš„å¾ªç¯è¿‡ç¨‹ï¼š

ä¸€ä¸ªEveent Loopåªè¦å­˜åœ¨ï¼Œå°±ä¼šä¸æ–­æ‰§è¡Œä¸‹è¾¹çš„æ­¥éª¤ï¼š

 *  1.åœ¨tasks(ä»»åŠ¡)é˜Ÿåˆ—ä¸­é€‰æ‹©æœ€è€çš„ä¸€ä¸ªtask,ç”¨æˆ·ä»£ç†å¯ä»¥é€‰æ‹©ä»»ä½•taské˜Ÿåˆ—ï¼Œå¦‚æœæ²¡æœ‰å¯é€‰çš„ä»»åŠ¡ï¼Œåˆ™è·³åˆ°ä¸‹è¾¹çš„microtasksæ­¥éª¤ã€‚
 *  2.å°†ä¸Šè¾¹é€‰æ‹©çš„taskè®¾ç½®ä¸º[æ­£åœ¨è¿è¡Œçš„task][task]ã€‚
 *  3.Run: è¿è¡Œè¢«é€‰æ‹©çš„taskã€‚
 *  4.å°†Eveent Loopçš„[currently running task][task]å˜ä¸ºnullã€‚
 *  5.ä»taské˜Ÿåˆ—é‡Œç§»é™¤å‰è¾¹è¿è¡Œçš„taskã€‚
 *  6.Microtasks: æ‰§è¡Œ[microtasksä»»åŠ¡æ£€æŸ¥ç‚¹][microtasks]ã€‚ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œmicrotasksé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼‰
 *  7.æ›´æ–°æ¸²æŸ“ï¼ˆUpdate the renderingï¼‰ï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºæµè§ˆå™¨æ¸²æŸ“...
 *  8.å¦‚æœè¿™æ˜¯ä¸€ä¸ªworker event loopï¼Œä½†æ˜¯æ²¡æœ‰ä»»åŠ¡åœ¨taské˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”[WorkerGlobalScope][]å¯¹è±¡çš„closingæ ‡è¯†ä¸ºtrueï¼Œåˆ™é”€æ¯Eveent Loopï¼Œä¸­æ­¢è¿™äº›æ­¥éª¤ï¼Œç„¶åè¿›è¡Œå®šä¹‰åœ¨[Web workers][]ç« èŠ‚çš„[run a worker][]ã€‚
 *  9.è¿”å›åˆ°ç¬¬ä¸€æ­¥ã€‚

Eveent Looppä¼šä¸æ–­å¾ªç¯ä¸Šé¢çš„æ­¥éª¤ï¼Œæ¦‚æ‹¬è¯´æ¥ï¼š

 *  `Eveent Loop`ä¼šä¸æ–­å¾ªç¯çš„å»å–`tasks`é˜Ÿåˆ—çš„ä¸­æœ€è€çš„ä¸€ä¸ªtask(å¯ä»¥ç†è§£ä¸ºå®ä»»åŠ¡ï¼‰æ¨å…¥æ ˆä¸­æ‰§è¡Œï¼Œå¹¶åœ¨å½“æ¬¡å¾ªç¯é‡Œä¾æ¬¡æ‰§è¡Œå¹¶æ¸…ç©º`microtask`é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚
 *  æ‰§è¡Œå®Œ`microtask`é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œæœ‰å¯èƒ½ä¼šæ¸²æŸ“æ›´æ–°ã€‚ï¼ˆæµè§ˆå™¨å¾ˆèªæ˜ï¼Œåœ¨ä¸€å¸§ä»¥å†…çš„å¤šæ¬¡domå˜åŠ¨æµè§ˆå™¨ä¸ä¼šç«‹å³å“åº”ï¼Œè€Œæ˜¯ä¼šç§¯æ”’å˜åŠ¨ä»¥æœ€é«˜60HZ(å¤§çº¦16.7msæ¯å¸§)çš„é¢‘ç‡æ›´æ–°è§†å›¾ï¼‰

### å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ä¼˜å…ˆé—®é¢˜ 

> åœ¨ä»»åŠ¡å¯¹åˆ—(queue)ä¸­æ³¨å†Œçš„å¼‚æ­¥å›è°ƒåˆåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ã€‚æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ç†è§£å¯ä»¥è®¤ä¸ºåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰å®ä»»åŠ¡é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚å®ä»»åŠ¡é˜Ÿåˆ—æœ‰å¤šä¸ªï¼Œå¾®ä»»åŠ¡åªæœ‰ä¸€ä¸ª

 *  å®ä»»åŠ¡(macro Task)
    
     *  script(æ•´ä½“ä»£ç )
     *  setTimeout/setInterval
     *  setImmediate(Nodeç¯å¢ƒ)
     *  UI æ¸²æŸ“
     *  requestAnimationFrame
     *  ....
 *  å¾®ä»»åŠ¡(micro Task)
    
     *  Promiseçš„then()ã€catch()ã€finally()é‡Œé¢çš„å›è°ƒ
     *  process.nextTick(Node ç¯å¢ƒï¼‰
     *  ...

ä¸ªäººç†è§£çš„æ‰§è¡Œé¡ºåºï¼š

1.  ä»£ç ä»å¼€å§‹æ‰§è¡Œè°ƒç”¨ä¸€ä¸ªå…¨å±€æ‰§è¡Œæ ˆï¼Œscriptæ ‡ç­¾ä½œä¸ºå®ä»»åŠ¡æ‰§è¡Œ
2.  æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»£ç ç«‹å³æ‰§è¡Œï¼Œå¼‚æ­¥ä»£ç æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä»»åŠ¡é˜Ÿåˆ—å­˜æ”¾æœ‰ä¸¤ç§ç±»å‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
3.  åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ä¹Ÿå°±æ„å‘³ç€ç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•(script)
    
     *  1ã€å…ˆæŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡
        
        1-1ã€æœ‰çš„è¯å°±å°†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡æ¸…ç©º
        
        2-2ã€å¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œåœ¨æ­¤æ¬¡æ‰§è¡Œä¸­ä¸€å¹¶æ¸…ç©º
     *  2ã€å¦‚æœæ²¡æœ‰å†çœ‹çœ‹å®ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰æ²¡æœ‰å®ä»»åŠ¡ï¼Œæœ‰çš„è¯æ‰§è¡Œï¼Œæ²¡æœ‰çš„è¯äº‹ä»¶è½®è¯¢ç¬¬ä¸€æ³¢ç»“æŸ
        
        2-1ã€æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—
        
        2-2ã€å®Œæˆå®ä»»åŠ¡ä¹‹åæ‰§è¡Œæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»£ç 

![image_45fc4514.png](../images//image_45fc4514.png)

> æ‰€ä»¥æ˜¯å®ä»»åŠ¡ä¼˜å…ˆï¼Œåœ¨å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰ä¼šæ¥ä¸€æ¬¡æ€§æ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ã€‚

### è§£é¢˜åˆ†æè¿‡ç¨‹ 

å°†æœ€å¼€å§‹çš„é‚£é“é¢˜æ¬ä¸‹æ¥

```java
// => ä»£ç ä¸€æ‰§è¡Œå°±å¼€å§‹æ‰§è¡Œäº†ä¸€ä¸ªå®ä»»åŠ¡-å®0
console.log('script start'); 

setTimeout(() => { // å® 1
  console.log('åŒ—æ­Œ');
}, 1 * 2000);

Promise.resolve()
    .then(function() { // å¾®1-1
      console.log('promise1');
    })
    .then(function() { // å¾®1-4 => è¿™ä¸ªthenä¸­çš„ä¼šç­‰å¾…ä¸Šä¸€ä¸ªthenæ‰§è¡Œå®Œæˆä¹‹åå¾—åˆ°å…¶çŠ¶æ€æ‰ä¼šå‘Queueæ³¨å†ŒçŠ¶æ€å¯¹åº”çš„å›è°ƒï¼Œå‡è®¾ä¸Šä¸€ä¸ªthenä¸­ä¸»åŠ¨æŠ›é”™ä¸”æ²¡æœ‰æ•è·ï¼Œé‚£å°±æ³¨å†Œçš„æ˜¯è¿™ä¸ªthenä¸­çš„ç¬¬äºŒä¸ªå›è°ƒäº†ã€‚
      console.log('promise2'); 
    });


async function foo() {
  await bar() // => await(promiseçš„è¯­æ³•ç³–)ï¼Œä¼šå¼‚æ­¥ç­‰å¾…è·å–å…¶è¿”å›å€¼
  // => åé¢çš„ä»£ç å¯ä»¥ç†è§£ä¸ºæ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—å¾®ä»»åŠ¡ä¸­ã€‚ è¿™é‡Œå¯ä»¥ä¿ç•™ç–‘é—®åé¢ä¼šè¯¦ç»†è¯´
  console.log('async1 end') // å¾®1-2
}
foo()

function bar() {
  console.log('async2 end') 
}

async function errorFunc () {
  try {
    await Promise.reject('error!!!')
  } catch(e) {
      // => ä»è¿™åé¢å¼€å§‹æ‰€æœ‰çš„ä»£ç å¯ä»¥ç†è§£ä¸ºæ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—å¾®ä»»åŠ¡ä¸­
    console.log(e)  // å¾®1-3
  }
  console.log('async1');
  return Promise.resolve('async1 success')
}
errorFunc().then(res => console.log(res)) // å¾®1-5

console.log('script end');
```

ä¸Šé¢ä»£ç å¯¹äºPromiseçš„ç”¨æ³•æˆ‘å°±ä¸å¤šè®²äº†, åœ¨åé¢æˆ‘ä¼šå†™å…³äºPromiseæºç è§£æçš„æ–‡ç« ã€‚

æ³¨æ„ä¸€ç‚¹å°±æ˜¯Promise.then().then()ï¼Œåœ¨æ³¨å†Œå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªthenä¸­çš„å›è°ƒæ˜¯ä¾èµ–ç¬¬ä¸€ä¸ªthenä¸­å›è°ƒçš„ç»“æœçš„ï¼Œå¦‚æœæ‰§è¡Œæ²¡æœ‰å¼‚å¸¸æ‰ä¼šåœ¨è¯¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ³¨å†ŒçŠ¶æ€å¯¹åº”çš„å›è°ƒ

#### ç¬¬ä¸€æ¬¡æ‰§è¡Œ 

å…¨å±€ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œ, è¾“å‡ºåŒæ­¥ä»£ç ã€‚æŒ‚è½½å®1ã€å¾®1-1ã€å¾®1-2ã€å¾®1-3ã€å¾®1-4ã€‚ 1-è¡¨ç¤ºå±äºç¬¬ä¸€æ¬¡è½®è¯¢

```java
run: script startã€ async2 endã€script end
```

#### ç¬¬äºŒæ¬¡æ‰§è¡Œ 

åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç ã€‚

å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šåªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ä¸”ä¼šåœ¨å½“å‰è½®è¯¢ä¸€æ¬¡æ¸…ç©º

```java
run:
	æ‰§è¡Œå¾®1-1: promise1
	æ‰§è¡Œå¾®1-2: async1 end
	æ‰§è¡Œå¾®1-3: error!!!ã€async1 ã€‚å½“å‰å¼‚æ­¥å›è°ƒæ‰§è¡Œå®Œæ¯•æ‰Promise.resolve('async1 success')ï¼Œç„¶åæ³¨å†Œthen()ä¸­çš„æˆåŠŸçš„å›è°ƒ-å¾®1-5
	æ‰§è¡Œå¾®1-4: promise2
    æ‰§è¡Œåˆšåˆšæ³¨å†Œçš„å¾®1-5: async1 success
```

åˆ°è¿™ç¬¬ä¸€æ³¢è½®è¯¢ç»“æŸ

#### ç¬¬ä¸‰æ¬¡æ‰§è¡Œ 

å¼€å¯ç¬¬äºŒæ³¢è½®è¯¢ï¼šæ‰§è¡Œå®1

```java
run: 'åŒ—æ­Œ'
```

åˆ°è¿™ã€‚æ•´ä¸ªè½®è¯¢ç»“æŸã€‚

> å…¶å®ç›¸å¯¹éš¾ä»¥ç†è§£çš„ä¹Ÿå°±æ˜¯å¾®ä»»åŠ¡ï¼Œå¯¹äºå¾®ä»»åŠ¡ä¹Ÿå°±æ˜¯ä¸Šé¢è¯´çš„åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­ä¸€æ¬¡æ¸…ç©º(åŒ…æ‹¬æ­¤æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡)ã€‚

ä¸¾ä¸ªæ —å­ğŸŒ°

ä½ å»å ‚é£Ÿæ’é˜Ÿæ‰“èœï¼ŒåŸæœ¬ä½ è®¡åˆ’ä»Šå¤©åªåƒä¸¤ä¸ªèœ(å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­åªæ³¨å†Œäº†ä¸¤ä¸ªå›è°ƒ)ï¼Œåœ¨æ‰“èœçš„è¿‡ç¨‹ä¸­ä½ çœ‹åˆ°ä½ æœ€å–œæ¬¢åƒçš„çº¢çƒ§è‚‰(å¾®ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„æ–°çš„å¾®ä»»åŠ¡)ï¼Œä½ è‚¯å®šå¾—å†åŠ ä¸ªèœ(å°†å¾®ä»»åŠ¡åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—)

#### ç”»å›¾åˆ†æ 

ç›¸ä¿¡é€šè¿‡ä¸Šé¢çš„è®²è§£ä½ ä»¬åº”è¯¥éƒ½èƒ½æ˜ç™½ï¼Œä¸ºäº†è®©ä½ ä»¬æ›´æ·±åˆ»çš„ç†è§£ï¼Œå½¢æˆè¾ƒå¼ºçš„åœºæ™¯å°è±¡ï¼Œæˆ‘ç”»äº†ä¸ªåŠ¨å›¾

![image_6380a448.png](../images//image_6380a448.png)

ä¸ºäº†å¤§å®¶æ–¹ä¾¿å¯¹ç…§ç€çœ‹ï¼Œæˆ‘å°†ä»£ç è´´äº†å‡ºæ¥

![image_77685a96.png](../images//image_77685a96.png)

## æ‰“æ€ªè¿›é˜¶ 

é€šè¿‡ä¸Šé¢çš„è®²è§£ç°åœ¨å¯ä»¥åˆ·å‡ é“é¢˜æ¥çœ‹çœ‹è‡ªå·±æ’‘æ¡çš„æ€ä¹ˆæ ·äº†ã€‚ï¼ˆæ›´æ–°ï¼šè§£æä¼šæœ‰ç‚¹é•¿å¯ä»¥è‡ªå·±å†™åšä¸€éå†æ¥çœ‹è·Ÿå¥½ç†è§£ï¼‰

è§„å®š ç°åœ¨ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œè¯·è®°ä½ä¸€ä¸‹è§„å®šï¼š

 *  åˆ†æä»¥æ¯æ¬¡è½®è¯¢åšä¸ºåˆ†æï¼ŒåŒæ­¥ä»£ç å—æ˜¯ç›´æ¥è¾“å‡ºç»“æœçš„
 *  å¼‚æ­¥ä»»åŠ¡ä»£ç å—ä¸­ï¼Œçº¢è‰²è¡¨ç¤ºå®ä»»åŠ¡ï¼Œç»¿è‰²è¡¨ç¤ºå¾®ä»»åŠ¡
 *  `å¾®1-`è¡¨ç¤ºç¬¬ä¸€æ¬¡è½®è¯¢ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼Œ`å¾®2-`è¡¨ç¤ºç¬¬äºŒæ¬¡ï¼Œä»¥æ­¤ç±»æ¨

### é»„é‡‘é¢˜ 

```java
console.log('1');

setTimeout(() => {
  console.log('2');
  Promise.resolve().then(() => {
    console.log('3');
  })
  new Promise((resolve) => {
    console.log('4');
    resolve();
  }).then(() => {
    console.log('5')
  })
})

Promise.reject().then(() => {
  console.log('13');
}, () => {
  console.log('12');
})

new Promise((resolve) => {
  console.log('7');
  resolve();
}).then(() => {
  console.log('8')
})

setTimeout(() => {
  console.log('9');
  Promise.resolve().then(() => {
    console.log('10');
  })
  new Promise((resolve) => {
    console.log('11');
    resolve();
  }).then(() => {
    console.log('12')
  })
})
```

è¿™é¢˜æ¯”è¾ƒç®€å•å°±ä¸è§£æäº†ã€‚

### ç –çŸ³é¢˜ 

```java
new Promise((resolve, reject) => {
  console.log(1)
  resolve()
})
.then(() => { // å¾®1-1
  console.log(2)
  new Promise((resolve, reject) => {
      console.log(3)
      setTimeout(() => { // å®2
        reject();
      }, 3 * 1000);
      resolve() // TODO æ³¨1
  })
    .then(() => { // å¾®1-2  TODO æ³¨2
      console.log(4)
      new Promise((resolve, reject) => {
          console.log(5)
          resolve();
      })
        .then(() => { // å¾®1-4
          console.log(7)
        })
        .then(() => { // å¾®1-6
          console.log(9)
        })
    })
    .then(() => {  // å¾®1-5 TODO æ³¨3
      console.log(8)
    })
})
.then(() => { // å¾®1-3
  console.log(6)
})
=
```

è§£æï¼š

#### ç¬¬ä¸€æ¬¡è½®è¯¢ 

scriptæ ‡ç­¾(å®0)æ‰§è¡Œ

è¾“å‡ºåŒæ­¥ä»£ç ï¼š

```java
1
```

æŒ‚è½½å¼‚æ­¥ä»»åŠ¡ï¼š

```java
() => { // å¾®1-1 -> åœ¨è¯¥å›è°ƒè¿˜æ²¡æœ‰è¢«æ”¾åˆ°ä¸»æ ˆä¸­æ‰§è¡Œçš„æ—¶å€™é‡Œé¢éƒ½æ˜¯æ™®é€šçš„ä»£ç ä½ ä¹Ÿä¸çŸ¥é“é‡Œé¢é‚£äº›æ˜¯å¼‚æ­¥ä»»åŠ¡
  console.log(2)
  new Promise((resolve, reject) => {
      console.log(3)
      setTimeout(() => {
        reject();
      }, 3 * 1000);
      resolve()
  })
    .then(() => { 
      console.log(4)
      new Promise((resolve, reject) => {
          console.log(5)
          resolve();
        })
        .then(() => { 
          console.log(7)
        })
        .then(() => { 
          console.log(9)
        })
    })
    .then(() => { 
      console.log(8)
    })
}
```

åŒæ­¥ä»£ç å®Œæ¯•çš„åŒæ—¶ç¬¬ä¸€ä¸ªå®ä»»åŠ¡ä¹Ÿæ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```java
å¾®1-1: 2ã€3
```

æ³¨1

> promiseçš„çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±ä¸å¯æ›´æ”¹(ä¸»åŠ¨æŠ›é”™è¿˜æ˜¯å¯ä»¥å½±å“ä¸‹ä¸€ä¸ªthençš„çŠ¶æ€çš„)ï¼Œrejectçš„é‚£ä¸ªæ”¾åˆ°å®ä»»åŠ¡ä¸­è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œæ‰€ä»¥å¾®1-1ä¸­çš„new PromiseçŠ¶æ€å°±æ˜¯fulfilledï¼Œ

æ³¨2

> å¾®1-1ä¸­çš„newPromiseç¡®å®šäº†çŠ¶æ€ä¹‹åï¼Œç¬¬ä¸€ä¸ªthenä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒå¯ä»¥è¢«æ³¨å†Œåˆ°å¼‚æ­¥ä»»åŠ¡ä¸­äº†ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå¯è¿˜æ²¡æœ‰è¢«æ³¨å†Œï¼Œä¸”åœ¨æŒ‚è½½å¥½å¾®1-2ï¼Œå¾®1-1å›è°ƒæ‰§è¡Œæ²¡æœ‰ä»»åŠ¡å¼‚å¸¸ï¼ŒçŠ¶æ€å»¶ç»­ä¸‹å»æŒ‚åœ¨æœ€å¤–å±‚çš„then(1-3)

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```java
() => { // å¾®1-2
      console.log(4)
      new Promise((resolve, reject) => {
          console.log(5)
          resolve();
        })
        .then(() => { 
          console.log(7)
        })
        .then(() => { 
          console.log(9)
        })
}

) => { // å¾®1-3
  console.log(6)
}
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```java
() => { // å®2
	reject();
 }
```

å¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¾®ä»»åŠ¡ï¼š

 *  å…ˆæ‰§è¡Œå¾®1-2

```java
å¾®1-2ï¼š 4ã€5
```

æ‰§è¡Œå¾®ä»»åŠ¡1-2ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©ºï¼Œä½†ä½ å¾—ç­‰å‰é¢çš„å¾®ä»»åŠ¡æ‰§è¡Œå®Œ(å¾ˆå¥½çš„è¯´æ˜äº†é˜Ÿåˆ—çš„å…ˆè¿›å…ˆå‡º):

```java
() => { // å¾®1-4
   console.log(7)
}

() => {  // å¾®1-5
   console.log(8)
}
```

æ³¨2

> è¿˜æ˜¯å’Œä¸Šé¢æŒ‚åœ¨å¾®1-3çš„å¥—è·¯ä¸€æ ·ï¼Œåœ¨å¾®-2æ‰§è¡Œåˆ°resolve()é‚£ä¸€æ­¥åï¼Œç´§è·Ÿç€çš„ç¬¬ä¸€ä¸ª.thenä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒçš„çŠ¶æ€å¯ä»¥ç¡®å®šäº†ï¼Œæ³¨å†Œå¾®1-4çš„ä½†æ˜¯ç¬¬äºŒä¸ªè¿˜æ²¡æœ‰è¢«æŒ‚åœ¨å™¢ï¼Œå› ä¸ºä»–ä¸Šé¢é‚£ä¸ªå›è°ƒéƒ½è¿˜æ²¡æ‰§è¡Œå‘¢(ä½ èƒ½ç¡®å®šä¸Šé¢é‚£ä¸ªthenä¸­æ²¡æœ‰ä¸»åŠ¨æŠ›é”™å˜›ï¼Ÿæ‰€ä»¥äºŒä¸ªthenä¹Ÿä¸ä¸€å®šå°±ä¼šæ³¨å†ŒæˆåŠŸçš„å›è°ƒ)ï¼Œåˆ°æ­¤ä¼˜èƒœå¾®1-2å°±æ‰§è¡Œå®Œäº†ï¼ŒçŠ¶æ€å‘ä¸‹å»¶ç»­å¾®1-2thenä¸‹é¢çš„thenä¸­å¯ä»¥å»æ³¨å†ŒæˆåŠŸçš„å›è°ƒäº†ï¼Œæ³¨å†Œå¾®1-5

 *  æ‰§è¡Œå¾®1-3

```java
å¾®1-3: 6
```

å¾®1-3æ‰§è¡Œå®Œæˆä¹‹åå¯ä»¥æ‰§è¡Œå¾®1-2æ‰§è¡Œè¿‡ç¨‹ä¸­çš„äº§ç”Ÿçš„å¾®ä»»åŠ¡äº†

 *  æ‰§è¡Œå¾®1-4

```java
å¾®1-4: 7
```

æ‰§è¡Œå¾®ä»»åŠ¡1-4ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©ºï¼Œä½†ä½ å¾—ç­‰å‰é¢çš„å¾®ä»»åŠ¡æ‰§è¡Œå®Œ(å¾ˆå¥½çš„è¯´æ˜äº†é˜Ÿåˆ—çš„å…ˆè¿›å…ˆå‡º):

```java
() => { // å¾®1-6
   console.log(9)
}
```

 *  æ‰§è¡Œå¾®1-5

```java
å¾®1-5: 8
```

å¾®1-5æ‰§è¡Œå®Œæˆä¹‹åå¯ä»¥æ‰§è¡Œå¾®1-4æ‰§è¡Œè¿‡ç¨‹ä¸­çš„äº§ç”Ÿçš„å¾®ä»»åŠ¡äº†

```java
å¾®1-6: 9
```

è‡³æ­¤å¾®ä»»åŠ¡ç»ˆäºè¢«æ¸…ç©ºäº†ï¼Œæ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```java
åŒæ­¥ä»£ç ï¼š 1
å¾®1-1: 2ã€3  
å¾®1-2ï¼š 4ã€5
å¾®1-3: 6
å¾®1-4: 7
å¾®1-5: 8
å¾®1-6: 9
```

#### ç¬¬äºŒæ¬¡è½®è¯¢ 

å¼€å¯å®2, è¿™æ®µä»£ç 

```java
() => { // å®2
	reject();
}
```

thençŠ¶æ€æ—©å·²ç¡®å®šï¼Œè¿™æ®µä»£ç æ²¡æœ‰ä¸ªé”¤å­ç”¨ã€‚

è¾“å‡ºç»“æœï¼š

```java
1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7 -> 8 -> 9
```

### ç‹è€…é¢˜ 

```java
Promise.resolve()
  .then(() => {
    console.log('promise1');
    return new Promise((resolve, reject) => {
        setTimeout(() => {
          console.log('timer2')
          resolve()
        }, 0)
    })
      .then(async () => {
        await foo();
        return new Error('error1')
      })
      .then((ret) => {
        setTimeout(() => {
          console.log(ret);
          Promise.resolve()
          .then(() => {
            return new Error('error!!!')
          })
          .then(res => {
            console.log("then: ", res)
          })
          .catch(err => {
            console.log("catch: ", err)
          })
        }, 1 * 3000)
      }, err => {
        console.log(err);
      })
      .finally((res) => {
        console.log(res);
        throw new Error('error2')
      })
      .then((res) => {
        console.log(res);
      }, err => {
        console.log(err);
      })
  })
  .then(() => {
    console.log('promise2');
  })

function foo() {
  setTimeout(() => { 
    console.log('async1');
  }, 2 * 1000);
}

setTimeout(() => {
  console.log('timer1')
  Promise.resolve()
    .then(() => {
      console.log('promise3')
    })
}, 0)

console.log('start');
```

è¿™é“é¢˜å’Œæœ€å¼ºç‹è€…é¢˜å·®ä¸å¤šï¼Œæˆ‘å…ˆç”¨è¿™ç§æ–¹å¼è§£æï¼Œä¸‹é¢é‚£é“é¢˜æœ‰æ¯ä¸€æ­¥çš„è§£æï¼Œä¸ç„¶å­—æ•°ä¼šè¶…(å»ºè®®æ”¾IDEä¸­åˆ†æ)ï¼š

```java
Promise.resolve()
  .then(() => { // å¾®1-1
    console.log('promise1');
    return new Promise((resolve, reject) => {
        setTimeout(() => { // å®3 
          console.log('timer2') 
          resolve() // TODO å› ä¸ºæ˜¯åœ¨å¼‚æ­¥ç¡®è®¤Promiseçš„çŠ¶æ€, 
                    // TODO æ‰€ä»¥å½“çŠ¶æ€è¿˜æ²¡æœ‰ç¡®å®šä¹‹å‰ä¸‹é¢çš„thenä¸­çš„å›è°ƒéƒ½ä¸ä¼šæ³¨å†Œå½“å¼‚æ­¥ä»»åŠ¡ä¸­
        }, 0)
    })
      .then(async () => { // å¾®3-1
        // TODO å…ˆçœ‹ç€
        // await è¡¨è¾¾å¼ç®€å•ç†è§£ä¸º'å¼‚æ­¥ç­‰å¾…'è·å–ç»“æœ, 
        // awaitæ˜¯ä¸ºäº†ä¼˜åŒ–'Promise'çš„thené“¾å†™æ³• ç›´æ¥å¸®ä½ å»å¼‚æ­¥ç­‰å¾…æ‹¿åˆ°ç»“æœ
        // å¯ä»¥ç†è§£ä¸º await foo() => Promise.then((res) => res) 
        // awaitè¡¨è¾¾å¼åé¢çš„ä»£ç å¯ä»¥çœ‹æˆ Promise.then((res) => res).then(() => {return new Error('error1')})

        console.log( await foo()) // TODO æ³¨: å¯¹äºawaitè§£é‡Šä¸‹é¢ç¬¬å››å¤©é¢˜çš„åˆ†æå¾ˆé€å½»äº†,ä¸çŸ¥é“å¯ä»¥å¾€ä¸‹çœ‹
        // TODO å†çœ‹ç€
        // await è¡¨è¾¾å¼éœ€è¦å¼‚æ­¥å»ç­‰å¾…è·å–,awaitè¡¨è¾¾å¼ä¸‹é¢çš„ä»£ç ç›¸å½“äºæŒ‚åœ¨åˆ°å¼‚æ­¥é˜Ÿåˆ—å¾®ä»»åŠ¡ä¸­
        // ä½†å‰ææ˜¯éœ€è¦å¼‚æ­¥ç­‰å¾…è·å–ç»“æœä¹‹å
        return new Error('error1') // å¾®4-1
      }) 
      .then((ret) => {  // å¾®4-2
        setTimeout(() => { // å®5
          console.log(ret);
          Promise.resolve()
          .then(() => { // å¾®5-1
            return new Error('error!!!')
          })
          .then(res => { // å¾®5-2
            console.log("then: ", res)
          })
          .catch(err => {
            console.log("catch: ", err)
          })
        }, 1 * 3000)
      }, err => {
        console.log(err);
      })
      .finally((res) => { // å¾®3-2 å‰é¢çŠ¶æ€ä¸ç¡®å®š,ä½†æ˜¯finallyä¸ç®¡çŠ¶æ€å¦‚ä½•éƒ½æ‰§è¡Œä¸”ä¸æ¥å—ä»»åŠ¡å‚æ•°
        console.log(res);
        throw new Error('error2')
      })
      .then((res) => { // å¾®3-3
        console.log(res);
      }, err => {
        console.log(err);
      })
  })
  .then(() => { // å¾®3-4
    console.log('promise2');
  })

async function foo() {
  setTimeout(() => { // å®4
    console.log('async1');
  }, 2 * 1000);
  return Promise.resolve(1)
}

setTimeout(() => { // å®2
  console.log('timer1')
  Promise.resolve()
    .then(() => { // å¾®2-1
      console.log('promise3')
    })
}, 0)

console.log('start');

/**
 * TODO å¾®1-è¡¨ç¤ºç¬¬ä¸€æ¬¡è½®è¯¢ä¸­çš„å¾®ä»»åŠ¡
 * 
 * ç¬¬ä¸€æ¬¡è½®è¯¢
 * ä»£ç é¦–æ¬¡åŠ è½½scriptä½œç”¨å®ä»»åŠ¡æ‰§è¡Œ: 
 *  æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å¾®1-1 å®2
 *  è¾“å‡º: start
 * 
 * å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•: å¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡åˆ—è¡¨, å¾®1-1
 *  æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å®3
 *  è¾“å‡º: promise1
 * 
 * 
 * 
 * ç¬¬äºŒæ¬¡è½®è¯¢
 * é¦–å…ˆæ‰§è¡Œå®ä»»åŠ¡: å®2
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å¾®2-1
 * è¾“å‡º: timer1
 * 
 * å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•: å¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡åˆ—è¡¨, å¾®2-1
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: æ— 
 * è¾“å‡º: promise3
 * 
 * 
 * 
 * 
 * ç¬¬ä¸‰æ¬¡è½®è¯¢
 * é¦–å…ˆæ‰§è¡Œå®ä»»åŠ¡: å®3
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å¾®3-1 å¾®3-2 å¾®3-3 å¾®3-4
 * è¾“å‡º: timer2  
 * 
 * å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•: å¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡åˆ—è¡¨, å¾®3-1 å¾®3-2 å¾®3-3 å¾®3-4
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å®4
 * è¾“å‡º: undefined error2 promise2
 * 
 * 
 * 
 * ç¬¬å››æ¬¡è½®è¯¢
 * é¦–å…ˆæ‰§è¡Œå®ä»»åŠ¡: å®4
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å¾®4-1
 * è¾“å‡º: async1
 * 
 * å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•: å¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡åˆ—è¡¨, å¾®4-1 
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å¾®4-2
 * è¾“å‡º: æ²¡æœ‰è¾“å‡º, ç°åœ¨çš„å›è°ƒåœ¨æ²¡æœ‰ç¡®å®šçŠ¶æ€éƒ½æ³¨å†Œè¿‡ä¸”åœ¨è½®è¯¢ä¸­è¢«è°ƒç”¨è¿‡, å¾ˆå¥½çš„è¯´æ˜äº†æŒ‚åœ¨å¼‚æ­¥æ—¶å€™çš„æ˜¯callBack
 * 
 * 
 * ç¬¬äº”æ¬¡è½®è¯¢
 * é¦–å…ˆæ‰§è¡Œå®ä»»åŠ¡: å®5
 * æŒ‚è½½å¼‚æ­¥ä»»åŠ¡: å¾®4-1
 * è¾“å‡º: error1 then: error1!!!
 */


// start ->promise1 -> timer1 -> promise3 -> timer2  -> undefined -> error2 -> 
// promise2 -> async1 -> error1 -> then: error!!!
```

### è£è€€ç‹è€… 

ä¸‹é¢è®©æˆ‘ä»¬æ¥ä¸€èµ·åšæœ€åè¿™é“é¢˜ã€‚

```java
async function async1() {
  console.log('async1 start');
  new Promise((resolve, reject) => {
    try {
      throw new Error('error1')
    } catch(e) {
      console.log(e);
    }
    setTimeout(() => { // å®3
      resolve('promise4')
    }, 3 * 1000);
  })
    .then((res) => { // å¾®3-1
      console.log(res);
    }, err => {
      console.log(err);
    })
    .finally(res => { // å¾®3-2 // TODOæ³¨3
      console.log(res);
    })
  console.log(await async2()); // å¾®4-1  TODO-æ³¨1
  console.log('async1 end'); // å¾®4-2 // TODO-æ³¨2
}

function async2() {
  console.log('async2');
  return new Promise((resolve) => {
    setTimeout(() => { // å®4
      resolve(2)
    }, 1 * 3000);
  })
}

console.log('script start');

setTimeout(() => { // å®2
  console.log('setTimeout');
}, 0)

async1();

new Promise((resolve) => {
  console.log('promise1');
  resolve();
})
  .then(() => { // å¾®1-2
    console.log('promise2');
    return new Promise((resolve) => {
      resolve()
    })
      .then(() => { // å¾®1-3
        console.log('then 1-1')
      })
  })
  .then(() => { // å¾®1-4
    console.log('promise3');
  })


console.log('script end');
```

#### è§„å®š 

ç°åœ¨ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œè¯·è®°ä½ä¸€ä¸‹è§„å®šï¼š

 *  åˆ†æä»¥æ¯æ¬¡è½®è¯¢åšä¸ºåˆ†æï¼ŒåŒæ­¥ä»£ç å—æ˜¯ç›´æ¥è¾“å‡ºç»“æœçš„
 *  å¼‚æ­¥ä»»åŠ¡ä»£ç å—ä¸­ï¼Œçº¢è‰²è¡¨ç¤ºå®ä»»åŠ¡ï¼Œç»¿è‰²è¡¨ç¤ºå¾®ä»»åŠ¡
 *  `å¾®1-`è¡¨ç¤ºç¬¬ä¸€æ¬¡è½®è¯¢ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼Œ`å¾®2-`è¡¨ç¤ºç¬¬äºŒæ¬¡ï¼Œä»¥æ­¤ç±»æ¨

#### ç¬¬ä¸€æ¬¡è½®è¯¢ 

scriptæ ‡ç­¾(å®0)æ‰§è¡Œ

è¾“å‡ºåŒæ­¥ä»£ç ï¼š

```java
script start -> async1 start -> error1 -> async2 -> promise1 -> script end
```

æŒ‚è½½å¼‚æ­¥ä»»åŠ¡:

```java
-() => { // å®2
-  console.log('setTimeout');
-}

-() => { // å®3
-  resolve('promise4')
-}

-() => { // å®4
-  resolve(2)
-}


+() => { // å¾®1-1
+  console.log('promise2');
+  return new Promise((resolve) => {
+  resolve()
+}
```

åŒæ­¥ä»£ç å®Œæ¯•çš„åŒæ—¶ç¬¬ä¸€ä¸ªå®ä»»åŠ¡ä¹Ÿæ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```java
å¾®1-1: promise2 -> å¾®1-2: then 1-1 -> å¾®1-3: promise3
```

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```java
+() => { // å¾®1-2
+  console.log('then 1-1')
+}

+() => { // å¾®1-3
+  console.log('promise3');
+}
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```java
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡
```

æ³¨1

> è¿™é‡Œå¾—è¯´ä¸€ä¸‹ï¼Œå¾ˆå¤šäººè®¤ä¸ºawaitå°†ä»£ç åŒæ­¥åŒ–çš„æ„æ€ï¼Œå…¶å®awaitæ˜¯Promiseçš„è¯­æ³•ç³–ï¼Œå†…éƒ¨çš„å®ç°ä¹Ÿæ˜¯ä¾é Promise, å…¶è¯ç”Ÿä¹Ÿå°±æ˜¯ä¸ºäº†ä¼˜åŒ–promiseçš„thené“¾å†™æ³•ï¼Œç”¨åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œè®©ä»£ç çœ‹èµ·æ¥æ›´ç®€æ´æ˜äº† awaitçš„çœŸå®æ„æ€æ˜¯ async wait(å¼‚æ­¥ç­‰å¾…çš„æ„æ€)awaitè¡¨è¾¾å¼ç›¸å½“äºè°ƒç”¨åé¢è¿”å›promiseçš„thenæ–¹æ³•ï¼Œå¼‚æ­¥ï¼ˆç­‰å¾…ï¼‰è·å–å…¶è¿”å›å€¼ã€‚å³ await<==>promise.then
> 
> è¿™é‡Œçš„async2å‡½æ•°è¿”å›çš„Promiseä¸­å¼€å¯äº†ä¸€ä¸ªå®ä»»åŠ¡ï¼Œawaitå¼‚æ­¥ç­‰å¾…éœ€è¦ç­‰å¾…å®ä»»åŠ¡æ‰§è¡Œæ‰èƒ½è·å–å…¶è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´å®ä»»åŠ¡ä¸æ‰§è¡Œawaitè¡¨è¾¾å¼å°±å‹æ ¹ä¸èƒ½è°ƒç”¨Promiseçš„thenæ–¹æ³•

æ³¨2

> å‰é¢è¯´è¿‡awaitè¡¨è¾¾å¼åé¢çš„ä»£ç å¯ä»¥ç®€å•ç†è§£ä¸ºæ”¾å…¥åˆ°å¾®ä»»åŠ¡ä¸­ï¼Œä½†æ˜¯å‰é¢await è¡¨è¾¾å¼å‹æ ¹å°±æ²¡æœ‰è·å–å¼‚æ­¥ç­‰å¾…çš„ç»“æœè¿™åé¢çš„ä»£ç ä»è·³å‡ºå½“å‰æ‰§è¡Œæ ˆåå°±å‹æ ¹æ²¡æœ‰æŒ‚è½½åˆ°å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œæœ‰äº›æ•™ç¨‹è¯´çš„await è¡¨è¾¾å¼åé¢çš„ä»£ç å¯ä»¥çœ‹æˆå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªè¿™ç§è¯´æ³•æ˜¯é”™è¯¯çš„ï¼

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```java
script start -> async1 start -> error1 -> async2 -> promise1 -> script end
å¾®1-1: promise2 -> å¾®1-2: then 1-1 -> å¾®1-3: promise3
```

#### ç¬¬äºŒæ¬¡è½®è¯¢ 

ä¸Šé¢ç¬¬ä¸€æ³¢è½®è¯¢ç»“æŸï¼Œå¼€å¯ç¬¬äºŒæ³¢è½®è¯¢

æ‰§è¡Œç¬¬äºŒä¸ªå®ä»»åŠ¡é˜Ÿåˆ—(å®ä»»åŠ¡é˜Ÿåˆ—åªå­˜æ”¾ä¸€ä¸ªå®ä»»åŠ¡)ï¼š

```java
å®2ï¼šsetTimeout
```

å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ²¡æœ‰äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡ã€‚ç¬¬äºŒæ¬¡è½®è¯¢ç»“æŸ

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```java
å®2ï¼šsetTimeout
```

#### ç¬¬ä¸‰æ¬¡è½®è¯¢ 

æ‰§è¡Œç¬¬ä¸‰ä¸ªå®ä»»åŠ¡é˜Ÿåˆ—(å®ä»»åŠ¡é˜Ÿåˆ—åªå­˜æ”¾ä¸€ä¸ªå®ä»»åŠ¡)ï¼š

```java
å®ä»»åŠ¡æœ¬èº«æ²¡æœ‰è¾“å‡ºå•¥ï¼Œä¸è¿‡ç¡®å®šäº†ä¸‹Promiseçš„çŠ¶æ€å¹¶ä¼ é€’äº†ä¸ª'promise4'ç»™ä¸‹ä¸€ä¸ªthenä¸­çš„æˆåŠŸå›è°ƒ
```

å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—:

```java
+(res) => { // å¾®3-1
+  console.log(res);
+}
```

å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```java
å¾®3-1: promise4 -> å¾®3-2: undefined
```

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```java
+res => { // å¾®3-2 // TODOæ³¨3
+  console.log(res);
+}
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```java
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡
```

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```java
å¾®3-1: promise4 -> å¾®3-2: undefined
```

æ³¨3

> å‰é¢è¯´è¿‡promise.finally()ä¹Ÿæ˜¯å¾®ä»»åŠ¡ï¼Œfinallyå¯ä»¥ç†è§£ä¸ºä¸ç®¡promiseçš„çŠ¶æ€æ˜¯æˆåŠŸæˆ–å¤±è´¥éƒ½è¦æ‰§è¡Œæˆ‘ã€‚ä½†æ˜¯æˆ‘ä¸æ¥å—ä»»ä½•ç»“æœã€‚å› æ­¤finallyæ¥å—ä¸åˆ°è¿”å›å€¼resä¸ºundefined

#### ç¬¬å››æ¬¡è½®è¯¢ 

æ‰§è¡Œç¬¬å››ä¸ªå®ä»»åŠ¡é˜Ÿåˆ—(å®ä»»åŠ¡é˜Ÿåˆ—åªå­˜æ”¾ä¸€ä¸ªå®ä»»åŠ¡)ï¼š

```java
å®ä»»åŠ¡æœ¬èº«æ²¡æœ‰è¾“å‡ºå•¥ï¼Œä¸è¿‡ç¡®å®šäº†ä¸‹Promiseçš„çŠ¶æ€å¹¶ä¼ é€’äº†ä¸ª2ç»™ä¸‹ä¸€ä¸ªthenä¸­çš„æˆåŠŸå›è°ƒ
```

å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—:

ä¸Šé¢è¯´è¿‡await => Promise.then(), ä¸Šé¢å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ç¡®å®šäº†promiseçŠ¶æ€å¯ä»¥å»è·å–å¼‚æ­¥ç­‰å¾…çš„ç»“æœã€‚ ç›¸å½“äºè¿™æ ·ï¼š Promise.then((res) => \{return res\}) è€Œawaitè¡¨è¾¾å¼åé¢çš„ä»£ç ç›¸å½“äºåœ¨å¼‚æ­¥ç­‰å¾…è·å–ç»“æœåæ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ ç›¸å½“äºè¿™æ ·ï¼š Promise.then((res) => \{return res\}).finally(() => \{\}), åªæœ‰åœ¨await è¡¨è¾¾å¼å‰é¢è·å–åˆ°ç»“æœåæ‰ä¼šåœ¨ä»£ç æŒ‚åœ¨åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­

å¯ä»¥åšä¸ªå®éªŒå°†ä¸Šé¢å¼‚æ­¥ç­‰å¾…å®šæ—¶å™¨çš„å€¼è®¾å®šä¸ºæ›´é•¿æ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™awaitè¡¨è¾¾å¼åé¢çš„ä»£ç æ˜¯ä¸ä¸ºå“åº”çš„ï¼Œåªæœ‰è·å–åˆ°äº†å¼‚æ­¥ç­‰å¾…çš„ç»“æœï¼Œæ‰ä¼šå“åº”ã€‚

```java
+(res) => {return res} // å¾®4-1

+() => {async1 end} // å¾®4-2
```

å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```java
å¾®4-1: 2 -> å¾®4-2: async1 end
```

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```java
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```java
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡
```

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```java
å¾®4-1: 2 -> å¾®4-2: async1 end
```

#### æ‰€æœ‰è½®è¯¢å®Œæ¯•ä¹‹åçš„å®Œæ•´ç»“æœ 

```java
script start -> async1 start -> error1 -> async2 -> promise1 -> script end
å¾®1-1: promise2 -> å¾®1-2: then 1-1 -> å¾®1-3: promise3

å®2ï¼šsetTimeout

å¾®3-1: promise4 -> å¾®3-2: undefined

å¾®4-1: 2 -> å¾®4-2: async1 end
```

# å†™åœ¨æœ€å 

å¯¹äºã€å‰ç«¯ä½“ç³»ã€‘è¿™ç³»åˆ—çš„æ–‡ç« æˆ‘æ˜¯æŠ±ç€å¾ˆè®¤çœŸï¼Œå¾ˆæƒ³å†™å¥½çš„å¿ƒæ€çš„ï¼Œä½†æ¯•ç«Ÿæˆ‘è¿˜æ˜¯å‰ç«¯å°ç™½&å†™ä½œæ–°äººï¼Œå¦‚æœæ–‡ç« ä¸­æœ‰é‚£å—å†™çš„ä¸å¤ªå¥½æˆ–æœ‰é—®é¢˜æ¬¢è¿å¤§å®¶æŒ‡å‡ºï¼Œæˆ‘ä¹Ÿä¼šåœ¨åé¢çš„æ–‡ç« ä¸åœä¿®æ”¹ã€‚ä¹Ÿå¸Œæœ›è‡ªå·±è¿›æ­¥çš„åŒæ—¶èƒ½è·Ÿä½ ä»¬ä¸€èµ·æˆé•¿ã€‚å–œæ¬¢æˆ‘æ–‡ç« çš„æœ‹å‹ä»¬ä¹Ÿå¯ä»¥å…³æ³¨ä¸€ä¸‹

æˆ‘ä¼šå¾ˆæ„Ÿæ¿€ç¬¬ä¸€æ‰¹å…³æ³¨æˆ‘çš„äººã€‚æ­¤æ—¶ï¼Œå¹´è½»çš„æˆ‘å’Œä½ ï¼Œè½»è£…ä¸Šé˜µï¼›è€Œåï¼Œå¯Œè£•çš„ä½ å’Œæˆ‘ï¼Œæ»¡è½½è€Œå½’ã€‚

## ç³»åˆ—æ–‡ç«  

[ã€å‰ç«¯ä½“ç³»ã€‘ä»åœ°åŸºå¼€å§‹æ‰“é€ ä¸€åº§ä¸‡ä¸ˆé«˜æ¥¼][Link 1]

[ã€å‰ç«¯ä½“ç³»ã€‘æ­£åˆ™åœ¨å¼€å‘ä¸­çš„åº”ç”¨åœºæ™¯å¯ä¸åªæ˜¯è§„åˆ™æ ¡éªŒ][Link 2]

## å‚è€ƒæ–‡ç«  

[æ·±å…¥ç†è§£ JavaScript Event Loop][JavaScript Event Loop]

[ä¸€æ¬¡å¼„æ‡‚Event Loop][Event Loop]


[Processing model]: https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23event-loop-processing-model
[task]: https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23currently-running-task
[microtasks]: https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23perform-a-microtask-checkpoint
[WorkerGlobalScope]: https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fworkers.html%23workerglobalscope
[Web workers]: https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fworkers.html%23workers
[run a worker]: https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fworkers.html%23run-a-worker
[Link 1]: https://juejin.cn/post/6867784542338416648
[Link 2]: https://juejin.cn/post/6872236622591721485
[JavaScript Event Loop]: https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F34229323
[Event Loop]: https://juejin.cn/post/6844903764202094606#heading-0
